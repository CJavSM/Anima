name: Backend Tests

on:
  push:
    name: Full-stack CI

    on:
      push:
        branches: [ main ]
      pull_request:
        branches: [ main ]

    jobs:
      backend-unit:
        name: Backend unit tests
        runs-on: ubuntu-latest
        strategy:
          matrix:
            python-version: [3.11]
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Set up Python ${{ matrix.python-version }}
            uses: actions/setup-python@v4
            with:
              python-version: ${{ matrix.python-version }}

          - name: Cache pip
            uses: actions/cache@v4
            with:
              path: ~/.cache/pip
              key: ${{ runner.os }}-pip-${{ hashFiles('**/server/requirements.txt') }}
              restore-keys: |
                ${{ runner.os }}-pip-

          - name: Install backend requirements
            run: |
              python -m pip install --upgrade pip
              pip install -r server/requirements.txt

          - name: Run backend unit tests (with coverage)
            working-directory: server
            env:
              PYTHONPATH: ${{ github.workspace }}/server
            run: |
              pytest -q tests/unit --cov=app --cov-report=xml:coverage.xml

          - name: Upload backend coverage to Codecov
            uses: codecov/codecov-action@v4
            with:
              files: server/coverage.xml
            env:
              # Optional: set CODECOV_TOKEN in repository secrets for private repos
              CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      frontend-build:
        name: Frontend build
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Use Node.js 18
            uses: actions/setup-node@v4
            with:
              node-version: 18

          - name: Cache node modules
            uses: actions/cache@v4
            with:
              path: |
                client/node_modules
                ~/.npm
              key: ${{ runner.os }}-node-${{ hashFiles('**/client/package-lock.json', '**/client/package.json') }}
              restore-keys: |
                ${{ runner.os }}-node-

          - name: Install frontend deps
            working-directory: client
            run: |
              npm ci

          - name: Build frontend
            working-directory: client
            run: |
              npm run build

      integration-tests:
        name: Integration tests (Postgres)
        runs-on: ubuntu-latest
        needs: [backend-unit, frontend-build]
        services:
          postgres:
            image: postgres:15
            env:
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: anima_test
            ports:
              - 5432:5432
            options: >-
              --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Set up Python 3.11
            uses: actions/setup-python@v4
            with:
              python-version: '3.11'

          - name: Install backend requirements
            run: |
              python -m pip install --upgrade pip
              pip install -r server/requirements.txt

          - name: Wait for Postgres
            env:
              DB_HOST: localhost
              DB_PORT: 5432
              DB_USER: postgres
              DB_PASSWORD: postgres
              DB_NAME: anima_test
            run: |
              python - <<'PY'
    import time, os, sys
    import psycopg
    dsn = f"host={os.environ['DB_HOST']} user={os.environ['DB_USER']} password={os.environ['DB_PASSWORD']} dbname={os.environ['DB_NAME']}"
    for i in range(30):
        try:
            conn = psycopg.connect(dsn)
            conn.close()
            print('Postgres is ready')
            sys.exit(0)
        except Exception as e:
            print('Waiting for Postgres...', e)
            time.sleep(1)
    print('Postgres not ready')
    sys.exit(1)
    PY

          - name: Run integration tests (with coverage)
            working-directory: server
            env:
              PYTHONPATH: ${{ github.workspace }}/server
              DB_HOST: localhost
              DB_PORT: 5432
              DB_USER: postgres
              DB_PASSWORD: postgres
              DB_NAME: anima_test
            run: |
              pytest -q tests --cov=app --cov-report=xml:coverage.xml

          - name: Upload integration coverage to Codecov
            uses: codecov/codecov-action@v4
            with:
              files: server/coverage.xml
            env:
              CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
